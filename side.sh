#!/bin/bash

# Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿
echo -e '\e[40m\e[32m'
echo -e 'â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— '
echo -e 'â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—'
echo -e 'â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•'
echo -e 'â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—'
echo -e 'â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘'
echo -e 'â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•'
echo -e '\e[0m'

echo -e "\nĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ» may.crypto{ğŸ¦…} Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ² ĞºÑƒÑ€ÑĞµ ÑĞ°Ğ¼Ñ‹Ñ… Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ½Ğ¾Ğ´ - https://t.me/maycrypto\n"

function show_menu {
  echo "1. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ´Ñƒ Side Protocol"
  echo "2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Side Protocol"
  echo "3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾ÑˆĞµĞ»ĞµĞº Side Protocol"
  echo "4. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾ÑˆĞµĞ»ĞµĞº Side Protocol"
  echo "5. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€Ğ° Side Protocol"
  echo "6. ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ¾Ğ´Ñ‹ Side Protocol"
  echo "7. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°"
  echo "8. Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¾Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°"
  read -p "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¾Ğ¿Ñ†Ğ¸Ñ: " option
  case $option in
    1) install_node ;;
    2) check_sync ;;
    3) create_wallet ;;
    4) import_wallet ;;
    5) create_validator ;;
    6) view_logs ;;
    7) check_balance ;;
    8) exit 0 ;;
    *) echo "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°" && show_menu ;;
  esac
}

function install_node {
  source <(curl -s https://raw.githubusercontent.com/itrocket-team/testnet_guides/main/utils/common.sh)
  
  printLogo

  read -p "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ ĞšĞĞ¨Ğ•Ğ›Ğ¬ĞšĞ: " WALLET
  echo 'export WALLET='$WALLET
  read -p "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ ĞœĞ¾Ğ½Ğ¸ĞºĞµÑ€: " MONIKER
  echo 'export MONIKER='$MONIKER
  read -p "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ ĞŸĞ¾Ñ€Ñ‚ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ 17, Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 26): " PORT
  echo 'export PORT='$PORT

  echo "export WALLET="$WALLET"" >> $HOME/.bash_profile
  echo "export MONIKER="$MONIKER"" >> $HOME/.bash_profile
  echo "export SIDE_CHAIN_ID="S2-testnet-2"" >> $HOME/.bash_profile
  echo "export SIDE_PORT="$PORT"" >> $HOME/.bash_profile
  source $HOME/.bash_profile

  printLine
  echo -e "ĞœĞ¾Ğ½Ğ¸ĞºĞµÑ€:        \e[1m\e[32m$MONIKER\e[0m"
  echo -e "ĞšĞ¾ÑˆĞµĞ»ĞµĞº:        \e[1m\e[32m$WALLET\e[0m"
  echo -e "Chain id:       \e[1m\e[32m$SIDE_CHAIN_ID\e[0m"
  echo -e "ĞŸĞ¾Ñ€Ñ‚ Ğ½Ğ¾Ğ´Ñ‹:  \e[1m\e[32m$SIDE_PORT\e[0m"
  printLine
  sleep 1

  printGreen "1. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Go..." && sleep 1
  cd $HOME
  VER="1.21.3"
  wget "https://golang.org/dl/go$VER.linux-amd64.tar.gz"
  sudo rm -rf /usr/local/go
  sudo tar -C /usr/local -xzf "go$VER.linux-amd64.tar.gz"
  rm "go$VER.linux-amd64.tar.gz"
  [ ! -f ~/.bash_profile ] && touch ~/.bash_profile
  echo "export PATH=$PATH:/usr/local/go/bin:~/go/bin" >> ~/.bash_profile
  source $HOME/.bash_profile
  [ ! -d ~/go/bin ] && mkdir -p ~/go/bin

  echo $(go version) && sleep 1

  source <(curl -s https://raw.githubusercontent.com/itrocket-team/testnet_guides/main/utils/dependencies_install)

  printGreen "4. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»..." && sleep 1
  cd $HOME
  rm -rf side
  git clone https://github.com/sideprotocol/side.git
  cd side
  git checkout v0.8.1
  make install

  printGreen "5. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ..." && sleep 1
  sided config node tcp://localhost:${SIDE_PORT}657
  sided config keyring-backend os
  sided config chain-id S2-testnet-2
  sided init $MONIKER --chain-id S2-testnet-2
  sleep 1
  echo done

  printGreen "6. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ genesis Ğ¸ addrbook..." && sleep 1
  wget -O $HOME/.side/config/genesis.json https://testnet-files.itrocket.net/side/genesis.json
  wget -O $HOME/.side/config/addrbook.json https://testnet-files.itrocket.net/side/addrbook.json
  sleep 1
  echo done

  printGreen "7. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ seeds, peers, ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ñ€Ñ‚Ñ‹, pruning, Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½ÑƒÑ Ñ†ĞµĞ½Ñƒ Ğ³Ğ°Ğ·Ğ°..." && sleep 1
  SEEDS="9c14080752bdfa33f4624f83cd155e2d3976e303@side-testnet-seed.itrocket.net:45656"
  PEERS="bbbf623474e377664673bde3256fc35a36ba0df1@side-testnet-peer.itrocket.net:45656"
  sed -i -e "s/^seeds *=.*/seeds = \"$SEEDS\"/; s/^persistent_peers *=.*/persistent_peers = \"$PEERS\"/" $HOME/.side/config/config.toml

  sed -i.bak -e "s%:1317%:${SIDE_PORT}317%g;
  s%:8080%:${SIDE_PORT}080%g;
  s%:9090%:${SIDE_PORT}090%g;
  s%:9091%:${SIDE_PORT}091%g;
  s%:8545%:${SIDE_PORT}545%g;
  s%:8546%:${SIDE_PORT}546%g;
  s%:6065%:${SIDE_PORT}065%g" $HOME/.side/config/app.toml

  sed -i.bak -e "s%:26658%:${SIDE_PORT}658%g;
  s%:26657%:${SIDE_PORT}657%g;
  s%:6060%:${SIDE_PORT}060%g;
  s%:26656%:${SIDE_PORT}656%g;
  s%^external_address = \"\"%external_address = \"$(wget -qO- eth0.me):${SIDE_PORT}656\"%;
  s%:26660%:${SIDE_PORT}660%g" $HOME/.side/config/config.toml

  sed -i -e "s/^pruning *=.*/pruning = \"custom\"/" $HOME/.side/config/app.toml
  sed -i -e "s/^pruning-keep-recent *=.*/pruning-keep-recent = \"100\"/" $HOME/.side/config/app.toml
  sed -i -e "s/^pruning-interval *=.*/pruning-interval = \"50\"/" $HOME/.side/config/app.toml

  sed -i 's|minimum-gas-prices =.*|minimum-gas-prices = "0.005uside"|g' $HOME/.side/config/app.toml
  sed -i -e "s/prometheus = false/prometheus = true/" $HOME/.side/config/config.toml
  sed -i -e "s/^indexer *=.*/indexer = \"null\"/" $HOME/.side/config/config.toml
  sleep 1
  echo done

  sudo tee /etc/systemd/system/sided.service > /dev/null <<EOF
  [Unit]
  Description=side node
  After=network-online.target
  [Service]
  User=$USER
  WorkingDirectory=$HOME/.side
  ExecStart=$(which sided) start --home $HOME/.side
  Restart=on-failure
  RestartSec=5
  LimitNOFILE=65535
  [Install]
  WantedBy=multi-user.target
  EOF

  printGreen "8. Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ´Ñƒ..." && sleep 1
  sided tendermint unsafe-reset-all --home $HOME/.side
  if curl -s --head curl https://testnet-files.itrocket.net/side/snap_side.tar.lz4 | head -n 1 | grep "200" > /dev/null; then
    curl https://testnet-files.itrocket.net/side/snap_side.tar.lz4 | lz4 -dc - | tar -xf - -C $HOME/.side
  else
    echo "Ğ½ĞµÑ‚ ÑĞ½Ğ°Ğ¿ÑˆĞ¾Ñ‚Ğ°"
  fi

  sudo systemctl daemon-reload
  sudo systemctl enable sided
  sudo systemctl restart sided
  show_menu
}

function check_sync {
  sided status 2>&1 | jq
  show_menu
}

function create_wallet {
  read -p "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ ĞšĞĞ¨Ğ•Ğ›Ğ¬ĞšĞ: " WALLET
  sided keys add $WALLET
  WALLET_ADDRESS=$(sided keys show $WALLET -a)
  VALOPER_ADDRESS=$(sided keys show $WALLET --bech val -a)
  echo "export WALLET_ADDRESS="$WALLET_ADDRESS >> $HOME/.bash_profile
  echo "export VALOPER_ADDRESS="$VALOPER_ADDRESS >> $HOME/.bash_profile
  source $HOME/.bash_profile
  show_menu
}

function import_wallet {
  read -p "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ ĞšĞĞ¨Ğ•Ğ›Ğ¬ĞšĞ: " WALLET
  sided keys add $WALLET --recover
  WALLET_ADDRESS=$(sided keys show $WALLET -a)
  VALOPER_ADDRESS=$(sided keys show $WALLET --bech val -a)
  echo "export WALLET_ADDRESS="$WALLET_ADDRESS >> $HOME/.bash_profile
  echo "export VALOPER_ADDRESS="$VALOPER_ADDRESS >> $HOME/.bash_profile
  source $HOME/.bash_profile
  show_menu
}

function create_validator {
  read -p "Ğ Ğ°Ğ½ĞµĞµ Ğ’Ñ‹ ÑƒĞ¶Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ»Ğ¸ Ğ½Ğ¾Ğ´Ñƒ Side? [Ğ´Ğ°/Ğ½ĞµÑ‚]: " response
  if [[ "$response" =~ ^([Ğ´Ğ”][Ğ°Ğ])$ ]]; then
    sided tx staking create-validator \
    --amount 1000000uside \
    --from $WALLET \
    --commission-rate 0.1 \
    --commission-max-rate 0.2 \
    --commission-max-change-rate 0.01 \
    --min-self-delegation 1 \
    --pubkey $(sided tendermint show-validator) \
    --moniker "$MONIKER" \
    --identity "" \
    --details "" \
    --chain-id S2-testnet-2 \
    --gas auto --fees 1000uside \
    -y
  else
    sided tx staking edit-validator \
    --commission-rate 0.1 \
    --new-moniker "$MONIKER" \
    --identity "" \
    --details "SideProtocol" \
    --from $WALLET \
    --chain-id S2-testnet-2 \
    --gas auto --fees 1000uside \
    -y
  fi
  show_menu
}

function view_logs {
  echo "Ğ§ĞµÑ€ĞµĞ· 15 ÑĞµĞºÑƒĞ½Ğ´ Ğ½Ğ°Ñ‡Ğ½ĞµÑ‚ÑÑ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ½Ğ¾Ğ´Ñ‹ Side Protocol. Ğ”Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ¼ĞµĞ½Ñ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ CTRL+C"
  sleep 15
  sudo journalctl -u sided -f
  show_menu
}

function check_balance {
  sided q bank balances $WALLET_ADDRESS
  show_menu
}

show_menu
